---
title: 职教云mooc 刷课
date: 2023-02-25 23:30 +0800
categories: [Python,Crawler]
tags: [icve]
img_path: /assets/images/icvemooc
---

1. 安装 google chrome，最好为全用户安装

2. 新建一个文件夹存放脚本，同时新建一个chrome文件夹（可自定义）用于存放用户数据

![image-20230225232333587](image-20230225232333587.png)

3. 新建一个 start.bat 

```
cd /d "C:\Program Files\Google\Chrome\Application\"
chrome.exe --remote-debugging-port=9999 --user-data-dir="D:\CODE\py_all\python\Crawler script\icvemooc\chrome"
pause
```

第一行，是chrome的安装位置，chrome.exe 的所在位置

第二行，后面的 --user-data-dir= 路径，路径是你 新建的 存放用户数据的位置

4. 点击运行 start.bat ,会打开一个chrome窗口，https://icve-mooc.icve.com.cn/cms/ 我们进行登录，点击 我的MOOC，之后在点击课程学习

![image-20230225232842137](image-20230225232842137.png)

这个样子就行，里面点击暂停就好，挂着

![image-20230225233747703](image-20230225233747703.png)

我们到目录这边，右键，点击 查看框架源代码

![image-20230225233925071](image-20230225233925071.png)

到这里，我们 CTRL+A 全选，然后 CTRL+C 复制，到我们的脚本的目录，保存为 data.html

![image-20230225233944465](image-20230225233944465.png)

注意：到这里的时候，通过start.bat打开的窗口不要关掉，一直放着，然后我们启动我们的python脚本

他会自己静音和播放，两个窗口都不要关掉就好

脚本刚刚写出来，有一些还不全面，提示等不够好，如果有问题，请联系我。

![image-20230225234539444](image-20230225234539444.png)

后附脚本：

```python
from selenium.webdriver.chrome.service import Service
from selenium.webdriver.chrome.options import Options
from selenium.webdriver.common.by import By
from selenium import webdriver
from lxml import etree
import time


def main():
    path =  Service('./chromedriver.exe')
    chrome_options = webdriver.ChromeOptions()
    chrome_options.add_experimental_option("debuggerAddress", "127.0.0.1:9999")
    driver = webdriver.Chrome(options=chrome_options)

    html = open("data.html", "r", encoding="utf-8").read()
    html = etree.HTML(html)

    currentCourseId = html.xpath('//input[@type="hidden"][@id="currentCourseId"]/@value')[0]

    all_unfinshed_obj = html.xpath("//div[@class='item_done_icon item_done_pos']/..")
    unfinshed_obj_xpath_list = get_unfinished_item(all_unfinshed_obj)
    urlAll = CreateURI(currentCourseId,unfinshed_obj_xpath_list)

    for i in urlAll:
        driver.get(i)
        time.sleep(1)
        driver.find_element(By.XPATH, '//*[@id="volumeIcon"]').click()
        driver.find_element(By.XPATH, '//*[@id="player_pause"]').click()
        
        time.sleep(get_length(driver,i) + 10)


def get_unfinished_item(obj):
    print("正在爬取未完成的项目~")
    unfinished_ids = []
    for i in obj:
        t = i.xpath("div[2]/@class='s_learn_type s_learn_doc'")
        if t:
            unfinished_ids.append(("doc",i.xpath("./@id")[0].replace("s_point_", "")))
        t = i.xpath("div[2]/@class='s_learn_type s_learn_video'")
        if t:
            unfinished_ids.append(("video",i.xpath("./@id")[0].replace("s_point_", "")))

    # print(unfinished_ids)
    return unfinished_ids


def get_length(driver,url):
    xpath = ""
    if "video" in url:
        xpath = "//span[@id='screen_player_time_2']//text()"
    else:
        return 0
    
    while True:
        html = driver.page_source
        html = etree.HTML(html)
        length_str = html.xpath(xpath)[0]
        h_m_s = [int(i) for i in length_str.split(":")]
        if len(h_m_s) == 3:
            s = int(h_m_s[0]) * 60 * 60 + int(h_m_s[1]) * 60 + int(h_m_s[2])
            if s != 0:
                return s
        elif len(h_m_s) == 2:
            s = int(h_m_s[0]) * 60 + int(h_m_s[1])
            if s != 0:
                return s


def CreateURI(courseId,unfinshed_obj_xpath_list):
    print("开始生成URI")
    uri_list = []
    for item in unfinshed_obj_xpath_list:
        uriType = item[0]
        itemID = item[1]

        v_u = 'https://course.icve.com.cn/learnspace/learn/learn/templateeight/content_%s.action?params.courseId=%s&params.itemId=%s&params.templateStyleType=0&_t=%s'%(uriType,courseId,itemID,str(round(time.time() * 1000)))
        print(v_u)
        uri_list.append(v_u)
    
    return uri_list


if __name__ == "__main__":
    main()
```

